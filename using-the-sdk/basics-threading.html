<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Multi-threading with PnP Core SDK | PnP Core SDK </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Multi-threading with PnP Core SDK | PnP Core SDK ">
    <meta name="generator" content="docfx 2.59.2.0">
    <meta name="description" content="The PnP Core SDK is a modern .NET SDK designed to work for Microsoft 365. It provides a unified object model for working with SharePoint Online and Teams which is agnostic to the underlying API's being called.">
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    <meta property="docfx:rel" content="../">
    <meta property="docfx:newtab" content="true">
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../images/logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/plamber/pnpcore/blob/dev/docs/using-the-sdk/basics-threading.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="multi-threading-with-pnp-core-sdk">Multi-threading with PnP Core SDK</h1>

<p>The key PnP Core SDK classes like <code>PnPContext</code>, the model classes (e.g. <code>IWeb</code>, <code>ITeamChannel</code>,...) and model collection classes (e.g. <code>IListCollection</code>, <code>ITeamChannelCollection</code>) are <strong>not thread-safe</strong> and therefore it's not recommended to build solutions that have multiple threads sharing these classes. Doing so may lead to unexpected results and exceptions.</p>
<div class="IMPORTANT">
<h5>Important</h5>
<p>While threading is a very attractive option to speed up operations do keep in mind that your application might get throttled sooner as throttling protection kicks in whenever the amount of requests an application makes in a given time window exceeds a certain threshold. The threshold itself is a dynamic one that depends on many factors. See the <a href="https://docs.microsoft.com/en-us/sharepoint/dev/general-development/how-to-avoid-getting-throttled-or-blocked-in-sharepoint-online">Avoid getting throttled or blocked in SharePoint Online</a> article for more details. Also do know that via the PnP Core SDK <code>EventHub</code> you can get notified when your code is throttled (see <a href="basics-eventhub.html">Using the PnP Core SDK Event hub</a> for more details).</p>
</div>
<h2 id="what-options-do-i-have-to-parallelize-operations">What options do I have to parallelize operations?</h2>
<p>The main thing to do is to <strong>create a <code>PnPContext</code> per thread</strong> by either creating a new one (e.g. if you're running a thread per site/web) or by cloning the current one in case you're parallelizing work inside the same site/web. Below code samples show two implementations of running operations for a given <code>IWeb</code> in parallel:</p>
<pre><code class="lang-csharp">var urls = new[] { &quot;https://contoso.sharepoint.com/sites/siteA&quot;, &quot;https://contoso.sharepoint.com/sites/siteB&quot; };

var parallelOps = new List&lt;Task&gt;();

foreach (var url in urls)
{
    var contextForSite = await context.CloneAsync(new Uri(url));
    parallelOps.Add(DoWork(contextForSite));
}
await Task.WhenAll(parallelOps);

private async Task DoWork(PnPContext context)
{
    await foreach (var list in context.Web.Lists.Where(p =&gt; p.Hidden == false).AsAsyncEnumerable())
    {
        // do something with the list
        context.Logger.LogInformation($&quot;Thread: {Thread.CurrentThread.ManagedThreadId}, list {list.Title}&quot;);
    }
    
    context.Dispose();
}
</code></pre>
<p>Slightly more complicated sample to setup, but once configured using a parallel async operation becomes really simple.</p>
<pre><code class="lang-csharp">// AsyncParallelForEach extension method
public static class ParallelExtensions
{    
    public static async Task AsyncParallelForEach&lt;T&gt;(this IAsyncEnumerable&lt;T&gt; source, Func&lt;T, Task&gt; body, int maxDegreeOfParallelism = DataflowBlockOptions.Unbounded, TaskScheduler scheduler = null)
    {
        var options = new ExecutionDataflowBlockOptions
        {
            MaxDegreeOfParallelism = maxDegreeOfParallelism
        };
        if (scheduler != null)
            options.TaskScheduler = scheduler;
        var block = new ActionBlock&lt;T&gt;(body, options);
        await foreach (var item in source)
            block.Post(item);
        block.Complete();
        await block.Completion;
    }
}

// Simple code to return test data as IAsyncEnumerable
public static async IAsyncEnumerable&lt;string&gt; GetUrlsToProcess()
{
    yield return &quot;https://contoso.sharepoint.com/sites/siteA&quot;;
    yield return &quot;https://contoso.sharepoint.com/sites/siteB&quot;;

    await Task.CompletedTask; 
}  

private async Task DoWorkAsync(PnPContext context)
{
    await foreach (var list in context.Web.Lists.Where(p =&gt; p.Hidden == false).AsAsyncEnumerable())
    {
        // do something with the list
        context.Logger.LogInformation($&quot;Thread: {Thread.CurrentThread.ManagedThreadId}, list {list.Title}&quot;);
    }
    
    context.Dispose();
}

// Perform async parallel foreach
await GetUrlsToProcess().AsyncParallelForEach(async url =&gt;
{
    var contextForSite = await context.CloneAsync(new Uri(url));
    await DoWorkAsync(contextForSite);
});
</code></pre>
</article>
          </div>
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              </nav>
            </div>
          </div>        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>PnP Core SDK<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer">
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>  </body>
</html>