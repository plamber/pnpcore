<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>PnP Core SDK - Azure Function v4 Sample using out-of-process with .NET 6 | PnP Core SDK </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="PnP Core SDK - Azure Function v4 Sample using out-of-process with .NET 6 | PnP Core SDK ">
    <meta name="generator" content="docfx 2.59.2.0">
    <meta name="description" content="The PnP Core SDK is a modern .NET SDK designed to work for Microsoft 365. It provides a unified object model for working with SharePoint Online and Teams which is agnostic to the underlying API's being called.">
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    <meta property="docfx:newtab" content="true">
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/plamber/pnpcore/blob/dev/docs/demos/Demo.AzureFunction.OutOfProcess.AppOnly/readme.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="pnp-core-sdk---azure-function-v4-sample-using-out-of-process-with-net-6">PnP Core SDK - Azure Function v4 Sample using out-of-process with .NET 6</h1>

<p>This solution demonstrates how to build a simple backend API in the form of an HTTP Trigger Azure Function. The sample contains a <code>CreateSite</code> function that creates a new site collection including a new site page containing some text and an image. This Azure function is using application permissions (app-only).</p>
<h2 id="source-code">Source code</h2>
<p>You can find the sample source code here: <a href="https://github.com/pnp/pnpcore/tree/dev/samples/Demo.AzureFunction.OutOfProcess.AppOnly">/samples/Demo.AzureFunction.OutOfProcess.AppOnly</a></p>
<div class="NOTE">
<h5>Note</h5>
<p>This sample was created with <a href="https://visualstudio.microsoft.com/vs/">Visual Studio 2022</a> using <a href="https://dotnet.microsoft.com/">.NET 6.0</a> and has been created as an <a href="https://docs.microsoft.com/en-us/azure/azure-functions/create-first-function-vs-code-csharp?tabs=in-process">Azure Function v4</a> running out-of-process (so using process isolation).</p>
</div>
<h2 id="sample-configuration">Sample configuration</h2>
<div class="NOTE">
<h5>Note</h5>
<p>For the sample setup, you will need to have a recent version of <a href="https://pnp.github.io/powershell/">PnP.PowerShell</a> installed on your machine.</p>
</div>
<h3 id="create-and-configure-the-azure-ad-application">Create and configure the Azure AD application</h3>
<p>Using PnP PowerShell this becomes really simple. Below cmdlet will create a new Azure AD application, will create a new self-signed certificate and will configure that cert with the Azure AD application. Finally the right permissions are configured and you're prompted to consent these permissions.</p>
<pre><code class="lang-powershell"># Ensure you replace contoso.onmicrosoft.com with your Azure AD tenant name
# Ensure you replace joe@contoso.onmicrosoft.com with the user id that's an Azure AD admin (or global admin)

Register-PnPAzureADApp -ApplicationName FunctionDemoSiteProvisiong -Tenant contoso.onmicrosoft.com -Store CurrentUser -GraphApplicationPermissions &quot;Sites.FullControl.All&quot; -SharePointApplicationPermissions &quot;Sites.FullControl.All&quot; -Username &quot;joe@contoso.onmicrosoft.com&quot; -Interactive
</code></pre>
<div class="IMPORTANT">
<h5>Important</h5>
<ul>
<li>Approving application permissions requires you to use a user which is Azure AD admin or global admin in your tenant</li>
<li>Once this cmdlet is done you do need to to copy <strong>certificate thumbprint</strong> and <strong>ClientId</strong> values as these will be needed for the configuration step</li>
</ul>
</div>
<p>If you prefer to manually create and configure the Azure AD application then follow these steps:</p>
<ol>
<li>Create a new (self-signed) certificate</li>
<li>Create a new Azure AD application and take note of the shown <strong>Application (client) ID</strong></li>
<li>Under <strong>Certificates &amp; secrets</strong> upload your certificate and take note of the shown <strong>thumbprint</strong></li>
<li>Under <strong>API permissions</strong> add these two <strong>application</strong> permissions:
<ol>
<li>Microsoft Graph -&gt; <code>Sites.FullControl.All</code> application permission</li>
<li>SharePoint -&gt; <code>Sites.FullControl.All</code> application permission</li>
</ol>
</li>
<li>Click on <strong>Grant consent for</strong> to consent the permissions for the application</li>
</ol>
<h3 id="configure-the-samples-configuration-file">Configure the sample's configuration file</h3>
<p>The demo function needs a configuration file named <code>local.settings.json</code>, copy the <code>local.settings.copyme.json</code> file into a file named <code>local.settings.json</code> and in the file properties set <code>Copy to output directory</code> to <code>Copy if newer</code>.</p>
<p>Once that's done you do have this file in project:</p>
<pre><code class="lang-json">{
  &quot;IsEncrypted&quot;: false,
  &quot;Values&quot;: {
    &quot;AzureWebJobsStorage&quot;: &quot;UseDevelopmentStorage=true&quot;,
    &quot;FUNCTIONS_WORKER_RUNTIME&quot;: &quot;dotnet-isolated&quot;,
    &quot;SiteUrl&quot;: &quot;&lt;base site collection url to connect to&gt;&quot;,
    &quot;TenantId&quot;: &quot;&lt;tenant id&gt;&quot;,
    &quot;ClientId&quot;: &quot;&lt;application client id&gt;&quot;,
    &quot;CertificateThumbPrint&quot;: &quot;&lt;thumbprint&gt;&quot;,
    &quot;WEBSITE_LOAD_CERTIFICATES&quot;: &quot;&lt;thumbprint&gt;&quot;
  },
  &quot;Host&quot;: {
    &quot;CORS&quot;: &quot;*&quot;
  }
}
</code></pre>
<p>After filling in the configuration data your file will look like this:</p>
<pre><code class="lang-json">{
  &quot;IsEncrypted&quot;: false,
  &quot;Values&quot;: {
    &quot;AzureWebJobsStorage&quot;: &quot;UseDevelopmentStorage=true&quot;,
    &quot;FUNCTIONS_WORKER_RUNTIME&quot;: &quot;dotnet-isolated&quot;,
    &quot;SiteUrl&quot;: &quot;https://contoso.sharepoint.com&quot;,
    &quot;TenantId&quot;: &quot;9bd71689-66cb-4560-bb09-ab908ec21437&quot;,
    &quot;ClientId&quot;: &quot;8bb62681-cddd-41e0-bfdf-ab908ec8a3c3&quot;,
    &quot;CertificateThumbPrint&quot;: &quot;1C3342BA9B5269FDBCDCAB5D6334F1A60C73B184&quot;,
    &quot;WEBSITE_LOAD_CERTIFICATES&quot;: &quot;1C3342BA9B5269FDBCDCAB5D6334F1A60C73B184&quot;
  },
  &quot;Host&quot;: {
    &quot;CORS&quot;: &quot;*&quot;
  }
}
</code></pre>
<h2 id="run-the-sample">Run the sample</h2>
<p>If you're using Visual Studio then press <strong>F5</strong> to launch the sample, if you're using command line then use <code>func start</code>.</p>
<div class="NOTE">
<h5>Note</h5>
<p>To use command line you first have to install the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=v4%2Cwindows%2Ccsharp%2Cportal%2Cbash%2Ckeda#v2">Azure function core tools version 4.x</a></p>
</div>
<p>With the sample running go to your browser and load this url: <code>http://localhost:7071/api/CreateSite?owner=joe@contoso.onmicrosoft.com&amp;sitename=azurefunctiondemo001</code>, doing this will call into your Azure function passing the owner of the site collection that will be created and the site collection name. You have to update the url parameters accordingly, above sample will result in a site collection with url <a href="https://contoso.sharepoint.com/sites/azurefunctiondemo001">https://contoso.sharepoint.com/sites/azurefunctiondemo001</a> having joe@contoso.onmicrosoft.com set as owner.</p>
<h2 id="deploy-the-sample-to-azure">Deploy the sample to Azure</h2>
<h3 id="create-azure-function-app">Create Azure Function App</h3>
<p>Go to the <a href="https://portal.azure.com/">Azure Portal</a> and create a new Function App (consumption plan) using following settings:</p>
<ul>
<li>Publish: <strong>Code</strong></li>
<li>Runtime stack: <strong>.NET</strong></li>
<li>Version: <strong>6</strong></li>
<li>Region: pick the region that works best for you</li>
</ul>
<p>Click <strong>Review + create</strong>, verify the settings and click <strong>Create</strong>. Now your function is provisioned in Azure.</p>
<h3 id="configure-the-function-app">Configure the Function App</h3>
<p>Once the Function App has been created navigate to <strong>Settings</strong> -&gt; <strong>Configuration</strong> and add the following <strong>Application settings</strong>:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>SiteUrl</td>
<td>base site collection url to connect to, e.g. <a href="https://contoso.sharepoint.com">https://contoso.sharepoint.com</a></td>
</tr>
<tr>
<td>TenantId</td>
<td>tenant id, e.g. 9bd71689-66cb-4560-bb09-ab908ec21437</td>
</tr>
<tr>
<td>ClientId</td>
<td>application client id, e.g. 8bb62681-cddd-41e0-bfdf-ab908ec8a3c3</td>
</tr>
</tbody>
</table>
<p>Click <strong>Save</strong> to persist the changes.</p>
<p>Under <strong>Function runtime settings</strong> verify the Runtime version is set to <strong>~4</strong>.</p>
<h3 id="deploying-the-certificate---use-keyvault">Deploying the certificate - use KeyVault</h3>
<p>Final configuration step needed is ensuring the Azure Function App can use the configured certificate. Quite often you want to reuse your certificate across multiple Azure resources and then consolidating all secrets and certificates in an Azure KeyVault is a commonly used scenario. So let's explain how to make that happen.</p>
<ul>
<li>Ensure the managed identity of the function is on: click on <strong>Settings</strong> -&gt; <strong>Identity</strong> and ensure System assigned status is set to <strong>On</strong></li>
<li>Navigate to your Azure KeyVault or create a new one if you've none available</li>
<li>In KeyVault click on <strong>Settings</strong> -&gt; <strong>Certificates</strong> -&gt; <strong>Generate/Import</strong> -&gt; select <strong>Import</strong> in the dropdown and provide a name and path the PFX file you've created earlier on via the <code>Register-PnPAzureADApp</code> Powershell cmdlet. Click <strong>Create</strong> to add the certificate</li>
<li>In KeyVault click on <strong>Settings</strong> -&gt; <strong>Access Policies</strong> -&gt; <strong>+ Add Access Policy</strong>:
<ul>
<li>Select Secret Permission <strong>Get</strong></li>
<li>Select Certificate Permission <strong>Get</strong></li>
<li>Select principal:
<ul>
<li>Click on <strong>none selected</strong></li>
<li>In the <strong>Principal</strong> page enter the name of the Azure Function App, this selects the managed identity that you've enabled before. Click <strong>Select</strong> to pick that principal</li>
</ul>
</li>
<li>Click <strong>Add</strong> to add the new Access Policy</li>
<li>Click <strong>Save</strong> to persist the changes</li>
</ul>
</li>
</ul>
<p>Using above steps you've now uploaded your certificate in a KeyVault and you've enabled your Function App to read secrets from the vault using it's managed identity. Final step is letting the Azure Function App now which certificate to pick. For that follow these steps:</p>
<ul>
<li>In KeyVault click on your certificate and then click on the <strong>Current version</strong>. The certificate details will be shown, copy the <strong>Certificate Identifier</strong> e.g. <code>https://mykeyvault.vault.azure.net/certificates/PnPCoreSDKDemo/6c752ad7218248b0976f387ef288523a</code></li>
<li>In the Function App navigate to <strong>Settings</strong> -&gt; <strong>Configuration</strong> and add the following <strong>Application setting</strong>. Note the certificate version identifier has been dropped from the URL.</li>
</ul>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>CertificateFromKeyVault</td>
<td>@Microsoft.KeyVault(SecretUri=https://mykeyvault.vault.azure.net/certificates/PnPCoreSDKDemo/)</td>
</tr>
</tbody>
</table>
<p>Click <strong>Save</strong> to persist the changes.</p>
<h3 id="deploying-the-certificate---local-upload-to-function-app">Deploying the certificate - local upload to Function App</h3>
<p>Previous steps showed you how to manage your certificate via KeyVault, but you can also opt to simply upload the certificate to the Azure Function App.</p>
<ul>
<li>Navigate to <strong>Settings</strong> -&gt; <strong>TLS/SSL Settings</strong> and click on <strong>Private Key Certificates (.pfx)</strong></li>
<li>Click on <strong>Upload Certificate</strong>, browse to the location of the PFX file you've created earlier on via the <code>Register-PnPAzureADApp</code> Powershell cmdlet. Click <strong>Upload</strong> to upload the certificate</li>
<li>Navigate to <strong>Settings</strong> -&gt; <strong>Configuration</strong> and add the following <strong>Application settings</strong></li>
</ul>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>CertificateThumbPrint</td>
<td>thumbprint, e.g. 1C3342BA9B5269FDBCDCAB5D6334F1A60C73B184</td>
</tr>
<tr>
<td>WEBSITE_LOAD_CERTIFICATES</td>
<td>thumbprint, e.g. 1C3342BA9B5269FDBCDCAB5D6334F1A60C73B184</td>
</tr>
</tbody>
</table>
<h3 id="deploy-the-function-app-code-from-visual-studio">Deploy the Function App code from Visual Studio</h3>
<p>Final step now that the Function App is configured is to deploy our bits.</p>
<ul>
<li>Right click the project in Visual Studio and choose <strong>Publish...</strong></li>
<li>Chose the <strong>Import Profile</strong> option:
<ul>
<li>Navigate to your Azure Function App in Azure Portal and click on <strong>Get publish profile</strong> from the <strong>Overview</strong> page</li>
<li>Select the downloaded profile</li>
</ul>
</li>
<li>Click on <strong>Publish</strong> to push your project to the Azure Function App</li>
</ul>
<h3 id="test-your-function-app-in-azure">Test your Function App in Azure</h3>
<p>To test your Function App you now need to build an URL that points to your Azure Function App + it's function authorization key. To that URL the <code>owner</code> and <code>siteName</code> URL parameters have to be added. To get your Azure Function URL follow these steps:</p>
<ul>
<li>Navigate to your Azure Function App in Azure Portal and Navigate to <strong>Functions</strong> -&gt; <strong>Functions</strong></li>
<li>Click on the <strong>CreateSite</strong> function</li>
<li>Click on <strong>Get Function Url</strong> and copy the proposed URL</li>
<li>Append <code>&amp;owner=joe@contoso.onmicrosoft.com&amp;sitename=azurefunctiondemo001</code></li>
</ul>
<p>The final result will be something along these lines:</p>
<p><code>https://myfunctionapphost.azurewebsites.net/api/CreateSite?code=OerO/tVAIGbCacM1e6PYi6MsH5rsHmzpjUmZMlKTYayDhcYMJ9zjZw==&amp;owner=joe@contoso.onmicrosoft.com&amp;sitename=azurefunctiondemo001</code></p>
</article>
          </div>
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              </nav>
            </div>
          </div>        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>PnP Core SDK<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer">
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>  </body>
</html>